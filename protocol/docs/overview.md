# GEO3 Protocol

Public and auditable infrastructure to record and reward environmental data using the **HGC (Hierarchical Geospatial Compression)** standard. The project combines physical sensors, geospatial compression, and smart contracts to create a DePIN network focused on Earth preservation.

## Requirements

- Node.js >= 18
- npm
- Hardhat 2.25+

## `.env` Configuration

The project uses environment variables for credentials and keys. Use the `.env.example` file as a reference:

```bash
cp .env.example .env
# edit with your information
```

- `PRIVATE_KEY`: private key of the deployer account.
- `API_KEY`: RPC provider key (Alchemy, Infura, etc.).
- `POLYGONSCAN_KEY`: Polygonscan API key (optional for verification).

## Repository Structure

```
contracts/    smart contracts
scripts/      deployment scripts
tests/        Hardhat tests
ignition/     modules for Hardhat Ignition
```

## Contracts

The on-chain stack is composed of the following contracts:

| Contract | Main Function |
|----------|-----------------|
| `GeoToken` | Native CGT token (ERC20) with *cap* and *permit*. Used for rewards. |
| `NodeDIDRegistry` | Decentralized identity registry for physical nodes (DID), with access control and EIP‑712 signature. |
| `GeoDataRegistry` | Stores geospatial data batches. Each batch has a `geoBatchId`, `merkleRoot`, and `dataCID` (IPFS/URL). |
| `GeoRewardManager` | Publishes weekly reward cycles (Merkle root) and allows `claim()` by node *controllers*. |
| `GeoCellIDLib` | Library for handling extended H3 identifiers for HGC compression. |

The data generated by sensors is compressed off‑chain, published to IPFS, and anchored on‑chain through the Merkle roots registered in `GeoDataRegistry`. Weekly, the oracle aggregates readings and the `GeoRewardManager` distributes CGT according to each node’s performance.

### GeoToken

ERC20 utility token (symbol **CGT**) with capped supply (`ERC20Capped`) and support for `permit` (EIP‑2612).  
Main roles:

- `MINTER_ROLE` – mints CGT (delegated to `GeoRewardManager`);
- `BURNER_ROLE` – burns tokens;
- `DEFAULT_ADMIN_ROLE` – configures roles and defines the `rewardManager`.

### NodeDIDRegistry

Decentralized identity registry for physical nodes.  
Features:

- `registerNode` / `registerMultipleNodes` validate EIP‑712 signature from hardware;
- maintains `controller` (responsible wallet) and `metadataURI` (DID Document);
- `MANAGER_ROLE` can activate/deactivate nodes and change controllers;
- integrates with `GeoDataRegistry` via `sensorResolver` to validate `nodeType`.

### GeoDataRegistry

Stores aggregated geospatial data batches.  
Features:

- `registerGeoBatch` and `registerGeoBatchBulk` publish `geoBatchId`, `merkleRoot`, and `dataCID`;
- epoch policy (`epochMinInterval`, `epochMaxDelay`);
- resolution restriction per `sensorType` (`setSensorType`);
- roles: `ORACLE_ROLE` publishes batches and `MANAGER_ROLE` adjusts parameters;
- uses `GeoCellIDLib` to validate `geoBatchId` in HGC.

### GeoRewardManager

Distributes CGT based on weekly cycles. Main functions:

- `publishCycle` records the Merkle root and issues tokens to the contract;
- `claim` validates Merkle proof, checks node status, and transfers CGT to the `controller`;
- uses `epochWindow` to map epochs from `GeoDataRegistry`.

### GeoCellIDLib

Utility library for the HGC standard. Allows extracting `sensorType` header, navigating between levels (`parentOf`, `aggregationGroup`), and comparing cells (`isAncestorOf`, `isSameRoot`) while maintaining compatibility with `H3` in *cell mode*.

## How to Compile

```bash
npm install
npm run compile
```

## How to Test

```bash
npm test
```

## Deploy

```bash
npx hardhat run scripts/deploy-geo3.js --network amoy
```

### Lint and Formatting

```bash
npm run lint
npm run format
```

### Verification on Polygonscan

```bash
npx hardhat verify --network amoy <address> <constructor-arguments>
```

Make sure to set `POLYGONSCAN_KEY` in `.env`. Constructor arguments can be checked in the deployment script.

## Registering Nodes

1. Each node signs an EIP‑712 message containing its `nodeAddress`, `controller`, `nodeType`, and `metadataURI`.
2. An account with `MANAGER_ROLE` calls `registerMultipleNodes` (or `registerNode`) passing the data and signatures.

Example in Hardhat script (ethers.js):

```js
const registry = await ethers.getContract("NodeDIDRegistry");
await registry.registerMultipleNodes(
  [nodeAddress],
  [nodeType],
  [controller],
  ["ipfs://cid"],
  [signature]
);
```

## Registering Data Batches

Only addresses with `ORACLE_ROLE` can register batches:

```js
const dataRegistry = await ethers.getContract("GeoDataRegistry");
const epoch = await dataRegistry.currentEpoch();
await dataRegistry.registerGeoBatch(
  epoch,
  geoBatchId,
  merkleRoot,
  "ipfs://data-cid"
);
```

It is possible to submit multiple batches at once with `registerGeoBatchBulk`.

## Hierarchical Geospatial Compression (HGC)

HGC is an extension to the **H3** hexagonal index that adds a binary header and hierarchical aggregation rules. This enables:

- Compressing large volumes of data while preserving spatial relationships;
- Grouping cells by resolution level (`GeoCellIDLib`);
- Building deterministic and auditable Merkle trees at low on-chain cost.

### `geoId` Composition

Each cell is identified by a 64-bit `geoId` with the following format:

```
[sensorType (8 bits)] [H3 cell index (56 bits)]
```

- **sensorType** – header defining the category of the sensor or metric (0‑255).
- **H3 cell index** – the 56 least significant bits preserve the standard H3 structure  
  in *cell mode*, including resolution level, base cell, and hierarchical digits.

By reserving the top 8 bits for `sensorType`, we can multiplex readings from different sensors without losing compatibility with the H3 ecosystem. All aggregation and navigation operations provided by `GeoCellIDLib` work on this same layout, enabling hierarchical compression and efficient cell comparison.

## Credits

The GEO3 project is an initiative of **Aura Tecnologia**, developed as public infrastructure for auditable environmental data.

The smart contracts of this protocol were created by **Thomaz Valadares Gontijo**, under the MIT license, as part of Aura’s commitment to open, reliable, and sovereign technology.

Contributions are welcome.

## License

Distributed under the MIT license. See `LICENSE` for more information.